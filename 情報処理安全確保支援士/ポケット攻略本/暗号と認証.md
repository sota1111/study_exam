# 暗号のいろは

## 暗号化方式
暗号化するための手順のことを**暗号化方式**といい、**暗号化アルゴリズム**と**鍵**に分けられる。

## 暗号とハッシュ値
同じハッシュ値になってしまう２つの情報を見つけるのが困難（**衝突発見困難性**）といった特徴がある。

## 暗号を評価する団体

### CRYPTREC
総務省、経済産業省、NICT、IPAなどからなる団体。

#### CRYPTRECリスト
電子政府における調達のために参照すべき暗号のリスト。

### NICT
国立研究開発法人情報通信研究機構の略称で、総務省と縁の深い団体。

### NIST
アメリカ国立標準技術研究所の略称で、技術標準の策定機関。
**FIPS PUB140**(暗号モジュールのセキュリティ水準要求事項)を定めた。



# 共通鍵暗号

## 共通鍵暗号の仕組み
暗号化と復号で同じ鍵を使う。

### 共通鍵の暗号方式：AES
広く普及したDESの安全性に黄信号が点ったため新しく作られた。
ブロック長は128bit固定で、鍵長は128bit、192bit、256bitから任意に選べる。

## 共通鍵暗号の欠点
- 送信者と受信者が同じ鍵を持つ必要がある。
- 鍵の数が増える。n人が参加するネットワークでn(n-1)/2個の鍵が必要。

## 量子暗号
量子鍵配送を指す。使い捨ての暗号鍵を事前に共有するための方法。
攻撃者が盗聴を行えば、必ず検出できる。
量子通信路を用いて安全に共有した乱数列を使い捨ての暗号鍵として用いることによって、原理的に第三者に解読されない秘匿通信が実現できる。



# 公開鍵暗号
暗号化する鍵と復号する鍵が異なる。

## 公開鍵暗号の特徴
暗号化を鍵（暗号化鍵）のことを公開鍵と呼ぶ。
復号鍵のことは秘密鍵と呼び区別する。
処理速度は遅い。

### 公開鍵暗号の鍵の数
鍵を使い回せるので鍵の数を減らすことができる。2n。

## 公開鍵暗号の欠点とハイブリッド暗号
公開鍵暗号は、暗号化と復号に大きな時間がかかり、CPUに負荷を掛ける。一般に共通鍵暗号の数百倍〜数千倍の時間が必要。

### ハイブリッド暗号
通信のスタート時は公開鍵暗号で通信し、使い捨てにする共通鍵を交換する。以降は、高速な共通鍵暗号方式を使って暗号通信を行う。

## 公開鍵暗号の実装技術

### RSA
広く使われている公開鍵暗号アルゴリズム。大きな数値の素因数分解に非常に時間がかかる性質を利用する。

### 楕円曲線暗号
楕円曲線上の演算規則を利用して鍵を生成する。離散対数問題を解くのにとても時間がかかる性質を利用する。RSAよりも短い鍵で安全性を確保できる。

### ハイブリッド暗号
公開鍵暗号方式の処理負荷を軽減するために、まず公開鍵暗号方式で通信路を確保して共通鍵を交換し、その後に共通鍵暗号方式で通信を行う。

## S/MIME
電子メールの拡張仕様であるMIMEに手を加えたもので、暗号化と認証の機能が追加されている。**暗号化には公開鍵暗号**が、**認証にはデジタル署名**が使われている。

### SMTPヘッダ
暗号化されない。
- 送信元アドレス
- 宛先アドレス
- 件名

### SMTPボディ
暗号化される。
- メール本文



# 認証

## 認証とアクセスコントロール

### 識別
サービスを受けようとしている人が誰かを認識するもの。ユーザIDなどがこれに該当する。

### 認証
申告されたユーザIDが、申告者本人のものか確認するステップ。ユーザIDは既知の情報なので、それだけですぐにサービスを始めるわけにはいけない。秘密の情報であるパスワードを使って本人確認をする。

### アクセス権管理
その人にどこまでのサービスを提供するか決める。

## パスワード認証
非常に漏れやすい。

### 予期せぬ伝搬対策
- 人前でパスワードを喋らない。
- メモしてパソコンに貼ったりしない。
- 既知の情報をパスワードにしない。
- 長大で複雑なパスワードにする。
- 定期的にパスワードを変更する。

## パスワード認証の仕組み

### PAP
パスワードそのものがネットワーク上を流れる認証方式で、現状で非常に危険な認証方法。別の仕組みを暗号化されている、物理的に盗聴が不可能な不可能な環境であるといった状況でないと使えない。

### CHAP
盗聴のリスクに対抗するには、以下の方法がある。
- パスワードを暗号化する。
- パスワードをネットワーク上に送信することなく認証を行う。

CHAPは**チャレンジレスポンス**というやり方で、パスワードを送信せずに認証する。

#### チャレンジレスポンス
1. クライアントは、ユーザIDを送信する。
2. サーバは、チャレンジコード（乱数）を返信する。
3. クライアントは、パスワードとチャレンジコードからハッシュ値を作り、サーバに送信する。
4. ユーザはユーザIDに対応するパスワードとチャレンジコードからハッシュ値を作り、クライアントから送られてきたハッシュと比較する。

### EAP
PPPで認証機能を付加したプロトコル。EAPが固定的な認証機能を持つわけではなく、枠組みを用意して、実際の認証にどんな技術を使うか選択できる。

## ワンタイムパスワード
- パスワードを使い捨てにする方法。
- 1回しか使用されないのなら、盗聴されたり推測されたりしても、不正利用する暇がない。

### S/KEY
サーバとクライアントに**同じパスフレーズ**をあらかじめ登録しておき、サーバが**乱数**と**シーケンス番号**で作った**シード**を**チャレンジコード**としてクライアントに送信する。
クライアント側でシーケンス番号-1回だけハッシュ処理を行い、それをワンタイムパスワードとして、サーバに送信することで、ワンタイムパスワードがネットワーク上に流れない。

### 時刻同期方式
パスワードを作る**ネタ(シード)として時刻**を使う。チャレンジコードをやり取りする必要がなく、ネットワークに余分な情報を流さない点で優れている。
その代わり、時刻から**トークンコード**と呼ばれる認証情報を作るトークンがサーバにもクライアントにも必要になる。
トークンコードと事前に登録してある**個人識別番号(PIN)**を合わせてワンタイムパスワードを作る。

#### 特徴
- サーバ/クライアント間での時刻同期が絶対の条件
- NTPと併用される
- 時刻のズレをどのくらい許容するかがミソ

## バイオメトリクス認証
生体認証と呼ばれ、人の生体情報を手がかりに本人確認をするやり方。

### 指紋
シリコンなどで指紋のコピーを作り、認証を突破したケースもある。

### 虹彩、網膜
目の情報を使って個人を識別する。高い精度で本人確認できるが、装置が大掛かりで、高コスト。

### 声紋
声から作られたエンベロープパターンを元に認証を行う。手軽に使えるが、認証精度は他の認証方法に比べると劣り、喉を痛める、加齢により誤認症を起こすこともある。

## その他の認証強化方法

### 多要素認証
知識による認証、生体認証、所有物による認証などのうち、いくつかを組み合わせて安全性を高める認証方法。

### リスクベース認証
**普段と異なる状況**が生じ、高いリスクが見込まれるときに、パスワード認証や画像認証を追加で行う仕組み。

### ソルト
パスワードを登録する際には直接保存せず、ハッシュ値にする。パスワードとランダムな文字列を加えてからこのハッシュ値を生成する。

### 耐タンパ性
外部機器から組織内の情報を読まれたり書き換えられたりすることにどれだけ耐えられるかを表す指標。

### TPM(Trusted Platform Module)
コンピュータの基板上に実装するセキュリティチップ。暗号化や復号、ハッシュ値の計算、デジタル署名、暗号鍵の保存などを行う。ソフトウェアでこれらを実現する方法に比べると耐タンパ性が高まる。

### RFID
ID情報を記載した無線対応チップ。人や商品の識別、管理、追跡などに使われる。バーコードに比べ、処理効率やトレーサビリティで優れる。



# デジタル署名
ネットワーク通信のリスクは盗聴、なりすまし、改ざん、事後否認がある。
盗聴は暗号化で対策し、なりすまし、改ざん、事後否認はデジタル署名で対策する。

## デジタル署名
デジタル署名は公開鍵暗号の仕組みを応用する。暗号化鍵と復号鍵のペアのうち、送信者が暗号化鍵を秘密に保持する。暗号化できたということは本人であることを示す。

### 手順
1. 送信者は文書を、暗号化鍵（秘密鍵）を使って暗号文にする。
2. 受信者は、復号鍵（公開鍵）を使って平文へ復号する。
3. 復号できれば、送信者が本人と確認できる。

### メッセージダイジェスト、ハッシュ関数
文書の長さを統一して処理をしやすくすること、通信中の盗聴リスクなどを考慮して、平文から**メッセージダイジェスト**（ハッシュ値）を作り、そこにデジタル署名をする。

## 主なハッシュ関数
- MD5：RSA社が開発した関数。どんな長さの平文からも128bitのメッセージダイジェストを作る。
- SHA-1：1995年から米国政府が使っていた関数。任意の長さの平文から160bitのメッセージダイジェストを作る。脆弱性が指摘されたため、米国政府が使う関数はSHA-2へと移行した。
- SHA-2：SHA-1の発展版。生成するbit数が長い方が安全なので、SHA-1の160bitから224、256、384、512bitのハッシュ値が得られるように改良された。ハッシュの長さによって、SHA-224、SHA-256などと呼ばれることもあるが、まとめてSHA-2と呼ぶのが一般的。
- SHA-3：SHA-2の次世代の規格。安全性の強化のため、共通鍵暗号方式のAESのアルゴリズムに変更している。



# 公開鍵基盤(PKI)
署名した人＝本人を保証する仕組み。

## 公開鍵基盤が必要な理由
**第三者が本人確認**をすることでなりすましを防ぐ。
署名を行おうとする人は、**認証局（CA）**と呼ばれる第三者機関に鍵ペアの公開鍵と身分証明を提出し、それに認証局の秘密鍵でデジタル署名してもらった**デジタル証明書**を発行してもらう。

## 登録局、発行局、検証局
認証局は、デジタル署名の登録業務を行う**登録局（RA）**と、発行業務（**IA**）を行う**発行局**、デジタル署名の正当性を確認する**検証局（VA）**に分けられる。証明書執行リスト（CRL）はVAが管理している。
役所だけでなく民間企業もサービスを提供している。
ブラウザには主要な認証局のデジタル証明書がインストールされている。

## 認証の階層
世の中の認証局のデジタル証明書を全てブラウザにインストールしておくことはできない。
認証局間に**階層**を作り、認証を連鎖させる。

階層構造の最上位に位置する認証局を**ルート認証局**と呼ぶ。
ルート認証局は自分自身の秘密鍵で署名をしてデジタル証明書を発行する。これを**ルート証明書**と呼ぶ。

## デジタル証明書の失効とCRL
デジタル証明書には**有効期限**が設定され、有効期限を過ぎた証明書は効力を失う。有効期限内であっても、鍵を紛失したり盗難されたりした場合は、認証局に届け出てデジタル証明書を失効させる。

### デジタル証明書の有効期限
デジタル証明書の有効期限は、デジタル証明書内に記載されている。

#### X.509
ITU-Tの勧告。

#### CRL（Certificate Revocation List：証明書失効リスト）
デジタル証明書の運用時にCRLをチェックするのは必須知識。

#### OCSP
CRLをチェックするためのプロトコル。

**OCSPクライアント**：問い合わせる側
**OCSPレスポンダ**：問い合わせに答える側

OCSPクライアントはデジタル証明書のシリアル番号、証明書発行者の識別名のハッシュ値を送り、OCSPレスポンダはその情報をもとにデジタル証明書が有効かを回答する。

## タイムスタンプ
電子文書の存在証明や完全性（改ざんや欠落の有無）の検査を行う。
電子文書に時刻情報を挿入し、その時点で文書が存在していたことを証明する。

### 時刻認証局（TSA）
利用者は時刻認証局に電子文書のハッシュ値を送る。

### 時刻配信局（TA）
時刻認証局は正しい時刻を時刻配信局から取得し、ハッシュと時刻情報からタイムスタンプトークンを作り、利用者に返信する。

### タイムスタンプトークン
**存在証明**と**完全性証明**を行う。
TSAの公開鍵で復号し、ハッシュ値を取り出し、文書のハッシュ値と比較する。



# 認証サーバ
アクセスポイントと認証機能を切り離して、リスクを分散する。認証サーバが課金管理機能を持っているのは、その名残。
通常の社内LANを運用する場合でも、セキュリティ水準の向上や運用の簡略化を企図して認証サーバが導入されるようになった。

## RADIUS
認証システム。アクセスサーバを作っていたメーカが開発したプロトコル（RADIUSのDIは、ダイヤルいんを表す）であるため、**認証機能**と**課金機能**（ログ管理機能）を持っているのが特徴。

### 特徴
- クライアント/サーバ型
- RADIUSサーバに接続するアクセスサーバ数には制限がない。
- トランスポート層プロトコルとして、UDPを使う。
- 外界への玄関口であるアクセスサーバに認証情報を置かない。

## DIAMETER
RADIUSの後継。

### AAAフレームワーク
- 認証(Authentication)
- 認可(Autorization)
- 課金(Accounting)

## Kerberos
認証システムの一つ。暗号化アルゴリズムが固定されていない。
**レルム**は、DNSでいうドメインに似た概念。レルムに参加するコンピュータ（**プリンシパル**）は鍵データをKDC（**鍵発行局**）に登録して、認証を受ける。

### 要素
- AS（認証サーバ）：クライアントの認証を行う
- TGS（チケット発行サーバ）：認証情報を暗号化した「チケット」の発行を行う
- KDB（鍵データベース）：プリンシパルの共通鍵を管理する

### 認証プロセス
1. プリンシパルがASにアクセスして、チケットを要求
2. ASはKDBからチケットを取り出して送信
3. プリンシパルはチケットをTGSに送信して、サーバ使用を要求
4. TGSはサーバ使用許可証と共通鍵を返信



# SSL/TLS
セキュリティ通信プロトコルで、暗号化と認証の機能を提供する。アプリケーション層からはTCPのように扱えるので、プログラムの修正を最小限に留められる。

## SSL/TLSの通信手順
ネットスケープ社が自社ブラウザのために開発したプロトコル。その後、標準化されTLSと名前を変えたが、今でもSSLという呼び方がよく使われる。

### 通信の特徴
- トランスポート層〜セッション層で動く
- http=TCP80番、https(SSL)=TCP443番
- デジタル証明書を利用したクライアント認証、サーバ認証ができる
- TCPを置き換えるのではなく、アプリとTCPの間で動作する

### SSL/TLSでの伝送路の確立手順（ハンドシェイク）
1. サーバを認証する
2. 暗号化アルゴリズムを決める
3. 暗号化鍵をMAC（メッセージダイジェスト）を作る

SSL/TLSのサーバ証明書の発行には強度の違いがある。

### 特徴
- SSL/TLSは暗号化と認証を行うプロトコル
- 基本的にはブラウザで使うが、他の通信の下位プロトコルとして使われることもある
- 暗号スイート（暗号化アルゴリズムとハッシュアルゴリズムの組み）を定義
- 暗号化アルゴリズムは複数から選べる
- ハイブリッド通信

### データ転送
TLS Recordというプロトコルに従って行われる。
1. 送りたいデータを規定のサイズに区切る
2. 区切ったデータにMACを付加
3. 暗号化する
4. Recordヘッダを暗号化データにつける

### HTTPの暗号化
暗号化通信としてSSL/TLSを、下位のプロトコルとしてTCPを使う。
この状態（スキーム）を**HTTPS**と呼ぶ。
使用するポート番号が変わる。